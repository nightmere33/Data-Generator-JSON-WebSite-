{% extends 'visa_form/base.html' %}
{% load i18n %}
{% load widget_tweaks %}

{% block title %}Create Visa Data - Mosaic Visa Generator{% endblock %}

{% block extra_head %}
<style>
    /* Enhanced form styling */
    .form-section {
        background: linear-gradient(145deg, #ffffff, #f8fafc);
        border-radius: 16px;
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    .applicant-card {
        background: linear-gradient(145deg, #ffffff, #f9fafb);
        border-radius: 14px;
        border-left: 5px solid #4f46e5;
        border-top: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }
    
    .applicant-card:hover {
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        transform: translateY(-4px);
        border-left-color: #7c3aed;
    }
    
    /* Enhanced form controls */
    .form-input, .form-select, .form-textarea {
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px 16px;
        font-size: 15px;
        transition: all 0.2s ease;
        background: white;
        width: 100%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        background: white;
    }
    
    .form-input:hover, .form-select:hover, .form-textarea:hover {
        border-color: #9ca3af;
    }
    
    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: block;
        font-size: 14px;
        letter-spacing: 0.3px;
    }
    
    .form-help {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
        display: flex;
        align-items: center;
    }
    
    .required-star {
        color: #ef4444;
        margin-left: 2px;
    }
    
    /* Error styling */
    .error-message {
        color: #dc2626;
        font-size: 12px;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .error-message i {
        font-size: 12px;
    }
    
    .field-error {
        border-color: #dc2626 !important;
        background-color: #fef2f2;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
        .mobile-form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-input, .form-select, .form-textarea {
            padding: 14px 16px;
            font-size: 16px;
        }
        
        .applicant-card {
            padding: 20px;
        }
    }
    
    /* Better remove button */
    .remove-applicant {
        position: absolute;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #f87171, #ef4444);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 5px rgba(239, 68, 68, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    
    .remove-applicant:hover {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        transform: scale(1.05);
        box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
    }
    
    .remove-applicant:active {
        transform: scale(0.98);
    }
    
    .remove-applicant i {
        font-size: 14px;
    }
    
    /* Section headers */
    .section-header {
        display: flex;
        align-items: center;
        padding: 20px;
        border-bottom: 2px solid #f3f4f6;
        background: linear-gradient(to right, #f8fafc, transparent);
    }
    
    .section-icon {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 16px;
        font-size: 20px;
        flex-shrink: 0;
    }
    
    /* Simple progress bar */
    .progress-steps {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        padding: 20px;
        border-radius: 50px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
    }
    
    .step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 18px;
        right: -50%;
        width: 100%;
        height: 2px;
        background: #e5e7eb;
        z-index: 0;
    }
    
    .step.active:not(:last-child)::after {
        background: linear-gradient(90deg, #4f46e5 50%, #e5e7eb 50%);
    }
    
    .step.completed:not(:last-child)::after {
        background: #4f46e5;
    }
    
    .step-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        background: white;
        border: 2px solid #e5e7eb;
        color: #9ca3af;
        z-index: 1;
        margin-bottom: 8px;
    }
    
    .step.active .step-icon {
        background: #4f46e5;
        border-color: #4f46e5;
        color: white;
    }
    
    .step.completed .step-icon {
        background: #10b981;
        border-color: #10b981;
        color: white;
    }
    
    .step-label {
        font-size: 12px;
        font-weight: 500;
        color: #9ca3af;
        text-align: center;
    }
    
    .step.active .step-label {
        color: #4f46e5;
        font-weight: 600;
    }
    
    .step.completed .step-label {
        color: #10b981;
    }
    
    @media (max-width: 640px) {
        .progress-steps {
            padding: 15px 10px;
        }
        .step-label {
            font-size: 10px;
        }
        .step-icon {
            width: 30px;
            height: 30px;
            font-size: 12px;
        }
    }
    
    /* Two-column grid */
    .two-col {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px;
    }
    
    @media (min-width: 768px) {
        .two-col {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    /* Field group styling */
    .field-group {
        background: white;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
        margin-bottom: 20px;
    }
    
    .field-group:focus-within {
        border-color: #4f46e5;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.1);
    }
    
    .field-group:last-child {
        margin-bottom: 0;
    }
    
    /* Compact field groups inside two-col */
    .two-col .field-group {
        margin-bottom: 0;
    }
    
    /* Small adjustments */
    .text-muted {
        color: #6b7280;
    }
    
    /* Add applicant button at bottom */
    .add-applicant-container {
        margin-top: 24px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Progress bar (unchanged) -->
    <div class="mb-10">
        <div class="progress-steps">
            <div class="step active">
                <div class="step-icon"><i class="fas fa-edit"></i></div>
                <span class="step-label">{% trans "Fill Form" %}</span>
            </div>
            <div class="step">
                <div class="step-icon"><i class="fas fa-eye"></i></div>
                <span class="step-label">{% trans "Preview" %}</span>
            </div>
            <div class="step">
                <div class="step-icon"><i class="fas fa-download"></i></div>
                <span class="step-label">{% trans "Download" %}</span>
            </div>
        </div>
    </div>

    <!-- Form -->
    <form method="post" class="space-y-8" id="visaForm" autocomplete="off" novalidate>
        {% csrf_token %}
        
        <!-- Common Information (unchanged) -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-globe-americas"></i>
                </div>
                <div>
                    <h2 class="text-xl md:text-2xl font-bold text-gray-900">{% trans "Common Application Information" %}</h2>
                    <p class="text-sm text-gray-600 mt-1">{% trans "Shared details for all applicants" %}</p>
                </div>
            </div>
            
            <div class="p-6 md:p-8">
                <!-- Two-column layout -->
                <div class="two-col">
                    <!-- Left Column -->
                    <div class="space-y-6">
                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-calendar-day mr-2 text-blue-500"></i>{% trans "Minimum Desired Date" %}
                                <span class="required-star">*</span>
                            </label>
                            {{ visa_form.start_date|add_class:"form-input"|attr:"required" }}
                            <p class="form-help">{% trans "Earliest acceptable appointment date" %}</p>
                            {% if visa_form.start_date.errors %}
                                    {% for error in visa_form.start_date.errors %}
                                        <div class="error-message"><i class="fas fa-exclamation-circle"></i> {{ error }}</div>
                                    {% endfor %}
                            {% endif %}
                        </div>
                        
                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-calendar-times mr-2 text-blue-500"></i>{% trans "Maximum Allowed Date" %}
                                <span class="required-star">*</span>
                            </label>
                            {{ visa_form.max_date|add_class:"form-input"|attr:"required" }}
                            <p class="form-help">{% trans "Latest acceptable appointment date" %}</p>
                        </div>
                        
                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-envelope mr-2 text-blue-500"></i>Email
                                <span class="required-star">*</span>
                            </label>
                            {{ visa_form.email|add_class:"form-input"|attr:"required" }}
                        </div>
                        
                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-phone mr-2 text-blue-500"></i>{% trans "Phone" %}
                                <span class="required-star">*</span>
                            </label>
                            {{ visa_form.phone_local|add_class:"form-input"|attr:"required" }}
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="space-y-6">
                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-file-alt mr-2 text-blue-500"></i>{% trans "Visa Type" %}
                                <span class="required-star">*</span>
                            </label>
                            {{ visa_form.visa|add_class:"form-select"|attr:"required" }}
                        </div>
                        
                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-flag mr-2 text-blue-500"></i>{% trans "Nationality" %}
                                <span class="required-star">*</span>
                            </label>
                            {{ visa_form.nationality|add_class:"form-select"|attr:"required" }}
                        </div>
                        
                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-users mr-2 text-blue-500"></i>{% trans "Relation" %}
                                <span class="required-star">*</span>
                            </label>
                            {{ visa_form.relations|add_class:"form-select"|attr:"required" }}
                            <p class="form-help">{% trans "Select the relationship to the main applicant" %}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Full-width fields -->
                <div class="mt-6 space-y-6">
                    <div class="field-group">
                        <label class="form-label">
                            <i class="fas fa-home mr-2 text-blue-500"></i>{% trans "Contact Address" %}
                            <span class="required-star">*</span>
                        </label>
                        {{ visa_form.contact_address|add_class:"form-textarea"|attr:"required" }}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="field-group">
                            <label class="form-label">
                                City
                                <span class="required-star">*</span>
                            </label>
                            {{ visa_form.contact_city|add_class:"form-input"|attr:"required" }}
                        </div>
                        <div class="field-group">
                            <label class="form-label">
                                Postal Code
                                <span class="required-star">*</span>
                            </label>
                            {{ visa_form.contact_postcode|add_class:"form-input"|attr:"required" }}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-plane-departure mr-2 text-blue-500"></i>{% trans "Departure Date" %}
                                <span class="required-star">*</span>
                            </label>
                            {{ visa_form.departure_date|add_class:"form-input"|attr:"required" }}
                        </div>
                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-plane-arrival mr-2 text-blue-500"></i>{% trans "Return Date" %}
                                <span class="required-star">*</span>
                            </label>
                            {{ visa_form.return_date|add_class:"form-input"|attr:"required" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applicants Section -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="flex-1">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-900">{% trans "Applicants Information" %}</h2>
                        <p class="text-sm text-gray-600 mt-1">{% trans "Add details for each applicant (maximum 5)" %}</p>
                    </div>
                </div>
            </div>
            
            <div class="p-6 md:p-8">
                <div id="applicant-formset" class="space-y-8">
                    {{ applicant_formset.management_form }}
                    
                    {% for form in applicant_formset %}
                    <div class="applicant-card p-6 md:p-8" data-index="{{ forloop.counter0 }}">
                        <!-- Remove button -->
                        {% if forloop.counter > 1 %}
                        <button type="button" class="remove-applicant" title="Remove Applicant">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        {% else %}
                        <button type="button" class="remove-applicant" title="Remove Applicant" style="display: none;">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        {% endif %}
                        
                        <div class="flex items-center mb-8">
                            <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl flex items-center justify-center mr-4 shadow-lg">
                                <i class="fas fa-user text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">{% trans "Applicant" %} {{ forloop.counter }}</h3>
                                <p class="text-gray-600 text-sm mt-1">{% trans "Personal and passport details" %}</p>
                            </div>
                        </div>
                        
                        <div class="two-col">
                            <!-- Left Column -->
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="field-group">
                                        <label class="form-label">
                                            {% trans "First Name" %}
                                            <span class="required-star">*</span>
                                        </label>
                                        {{ form.name|add_class:"form-input"|attr:"required" }}
                                    </div>
                                    <div class="field-group">
                                        <label class="form-label">
                                            {% trans "Last Name" %}
                                            <span class="required-star">*</span>
                                        </label>
                                        {{ form.surname|add_class:"form-input"|attr:"required" }}
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="field-group">
                                        <label class="form-label">
                                            {% trans "Gender" %}
                                            <span class="required-star">*</span>
                                        </label>
                                        {{ form.gender|add_class:"form-select"|attr:"required" }}
                                    </div>
                                    <div class="field-group">
                                        <label class="form-label">
                                            {% trans "Marital Status" %}
                                            <span class="required-star">*</span>
                                        </label>
                                        {{ form.marital_status|add_class:"form-select"|attr:"required" }}
                                    </div>
                                </div>
                                
                                <div class="field-group">
                                    <label class="form-label">
                                        {% trans "Date of Birth" %}
                                        <span class="required-star">*</span>
                                    </label>
                                    {{ form.birthday|add_class:"form-input"|attr:"required"|attr:"type:date" }}
                                </div>
                                
                                <div class="field-group">
                                    <label class="form-label">
                                        {% trans "Place of Birth" %}
                                        <span class="required-star">*</span>
                                    </label>
                                    {{ form.birth_place|add_class:"form-input"|attr:"required" }}
                                </div>

                                <div class="field-group">
                                    <label class="form-label">
                                        {% trans "Passport Number" %}
                                        <span class="required-star">*</span>
                                    </label>
                                    {{ form.passport_number|add_class:"form-input"|attr:"required" }}
                                </div>

                                <div class="field-group">
                                    <label class="form-label">
                                        {% trans "Occupation" %}
                                        <span class="required-star">*</span>
                                    </label>
                                    {{ form.occupation|add_class:"form-select"|attr:"required" }}
                                </div>
                            </div>
                            
                            <!-- Right Column -->
                            <div class="space-y-6">
                                <div class="field-group">
                                    <label class="form-label">
                                        {% trans "Father's Full Name" %}
                                        <span class="required-star">*</span>
                                    </label>
                                    {{ form.father_name|add_class:"form-input"|attr:"required" }}
                                </div>
                                
                                <div class="field-group">
                                    <label class="form-label">
                                        {% trans "Mother's Full Name" %}
                                        <span class="required-star">*</span>
                                    </label>
                                    {{ form.mother_name|add_class:"form-input"|attr:"required" }}
                                </div>
                                
                                <div class="field-group">
                                    <label class="form-label">
                                        {% trans "Travel Document Type" %}
                                        <span class="required-star">*</span>
                                    </label>
                                    {{ form.travel_document|add_class:"form-select"|attr:"required" }}
                                </div>
                                
                                <div class="field-group">
                                    <label class="form-label">
                                        {% trans "Passport Issued By" %}
                                        <span class="required-star">*</span>
                                    </label>
                                    {{ form.passport_issued_by|add_class:"form-input"|attr:"required" }}
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="field-group">
                                        <label class="form-label">
                                            {% trans "Issue Date" %}
                                            <span class="required-star">*</span>
                                        </label>
                                        {{ form.passport_issue_date|add_class:"form-input"|attr:"required"|attr:"type:date" }}
                                    </div>
                                    <div class="field-group">
                                        <label class="form-label">
                                            {% trans "Expiry Date" %}
                                            <span class="required-star">*</span>
                                        </label>
                                        {{ form.passport_expiry|add_class:"form-input"|attr:"required"|attr:"type:date" }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Add Applicant button -->
                <div class="add-applicant-container">
                    <button type="button" id="add-applicant" 
                            class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex items-center justify-center mx-auto">
                        <i class="fas fa-user-plus mr-2"></i> {% trans "Add Another Applicant" %}
                    </button>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="bg-white rounded-2xl shadow-lg p-8 border border-gray-100">
            <div class="flex flex-col lg:flex-row justify-between items-center gap-8">
                <div class="text-center lg:text-left">
                    <h3 class="text-lg font-bold text-gray-900 mb-2">{% trans "Ready to Generate JSON?" %}</h3>
                    <p class="text-gray-600 text-sm">
                        <i class="fas fa-shield-alt mr-1 text-green-500"></i>
                        {% trans "Your data is processed locally and not stored on our servers" %}
                    </p>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
                    <button type="reset" 
                            class="bg-gray-50 hover:bg-gray-100 text-gray-700 font-semibold py-4 px-8 rounded-xl border border-gray-200 transition-all duration-300 flex items-center justify-center order-2 sm:order-1">
                        <i class="fas fa-redo mr-3"></i> {% trans "Clear Form" %}
                    </button>
                    <button type="submit" 
                            class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-4 px-10 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex items-center justify-center order-1 sm:order-2">
                        <i class="fas fa-eye mr-3"></i> {% trans "Preview & Generate JSON" %}
                        <i class="fas fa-arrow-right ml-3"></i>
                    </button>
                </div>
            </div>
            
            <div class="mt-8 pt-8 border-t border-gray-100">
                <div class="flex flex-col md:flex-row items-center justify-center gap-6 text-sm text-gray-600">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-info-circle text-sm"></i>
                        </div>
                        <span>{% trans "All fields are required unless marked optional" %}</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-calendar-alt text-sm"></i>
                        </div>
                        <span>{% trans "Dates should be in YYYY-MM-DD format" %}</span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const formset = document.getElementById('applicant-formset');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const addBtn = document.getElementById('add-applicant');
        let formCount = parseInt(totalForms.value);
        
        // Initialize remove buttons
        function initializeRemoveButtons() {
            document.querySelectorAll('.remove-applicant').forEach((btn, index) => {
                if (index === 0) btn.style.display = 'none';
                btn.addEventListener('click', function() {
                    const card = this.closest('.applicant-card');
                    if (formCount > 1) {
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(100px)';
                        setTimeout(() => {
                            card.remove();
                            formCount--;
                            totalForms.value = formCount;
                            updateFormIndices();
                            showToast('Applicant removed successfully', 'info');
                        }, 300);
                    }
                });
            });
        }
        initializeRemoveButtons();
        
        // Add new applicant
        if (addBtn) {
            addBtn.addEventListener('click', function() {
                if (formCount < 5) {
                    const template = document.querySelector('.applicant-card');
                    const newForm = template.cloneNode(true);
                    newForm.dataset.index = formCount;
                    
                    const inputs = newForm.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        if (input.name) input.name = input.name.replace(/-\d+-/, `-${formCount}-`);
                        if (input.id) input.id = input.id.replace(/-\d+-/, `-${formCount}-`);
                        if (input.type !== 'hidden' && !input.classList.contains('form-select')) {
                            input.value = '';
                        }
                    });
                    
                    const title = newForm.querySelector('h3');
                    if (title) title.textContent = `Applicant ${formCount + 1}`;
                    
                    const userIcon = newForm.querySelector('.fa-user');
                    if (userIcon) {
                        userIcon.parentElement.innerHTML = `<i class="fas fa-user text-lg"></i><span class="text-xs absolute -top-1 -right-1 bg-white text-indigo-600 rounded-full w-5 h-5 flex items-center justify-center font-bold">${formCount + 1}</span>`;
                    }
                    
                    const removeBtn = newForm.querySelector('.remove-applicant');
                    if (removeBtn) {
                        removeBtn.style.display = 'flex';
                        removeBtn.addEventListener('click', function() {
                            const card = this.closest('.applicant-card');
                            if (formCount > 1) {
                                card.style.opacity = '0';
                                card.style.transform = 'translateX(100px)';
                                setTimeout(() => {
                                    card.remove();
                                    formCount--;
                                    totalForms.value = formCount;
                                    updateFormIndices();
                                    showToast('Applicant removed successfully', 'info');
                                }, 300);
                            }
                        });
                    }
                    
                    newForm.style.opacity = '0';
                    newForm.style.transform = 'translateY(20px)';
                    formset.appendChild(newForm);
                    
                    setTimeout(() => {
                        newForm.style.opacity = '1';
                        newForm.style.transform = 'translateY(0)';
                        newForm.style.transition = 'all 0.4s ease';
                    }, 10);
                    
                    formCount++;
                    totalForms.value = formCount;
                    
                    setTimeout(() => {
                        newForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                    
                    showToast(`Applicant ${formCount} added successfully!`, 'success');
                } else {
                    showToast('Maximum of 5 applicants allowed', 'warning');
                    addBtn.disabled = true;
                    addBtn.innerHTML = '<i class="fas fa-ban mr-2"></i> Maximum Reached';
                    addBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            });
        }
        
        function updateFormIndices() {
            const forms = document.querySelectorAll('.applicant-card');
            forms.forEach((form, index) => {
                form.dataset.index = index;
                const title = form.querySelector('h3');
                if (title) title.textContent = `Applicant ${index + 1}`;
                
                const userIconContainer = form.querySelector('.fa-user')?.parentElement;
                if (userIconContainer) {
                    userIconContainer.innerHTML = `<i class="fas fa-user text-lg"></i><span class="text-xs absolute -top-1 -right-1 bg-white text-indigo-600 rounded-full w-5 h-5 flex items-center justify-center font-bold">${index + 1}</span>`;
                }
                
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.name) input.name = input.name.replace(/-\d+-/, `-${index}-`);
                    if (input.id) input.id = input.id.replace(/-\d+-/, `-${index}-`);
                });
                
                const removeBtn = form.querySelector('.remove-applicant');
                if (removeBtn) removeBtn.style.display = index === 0 ? 'none' : 'flex';
            });
            
            if (formCount < 5 && addBtn) {
                addBtn.disabled = false;
                addBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i> Add Another Applicant';
                addBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                addBtn.classList.add('bg-gradient-to-r', 'from-indigo-600', 'to-purple-600', 'hover:from-indigo-700', 'hover:to-purple-700', 'hover:shadow-xl', 'hover:-translate-y-1');
            }
        }
        
        function showToast(message, type = 'info') {
            document.querySelectorAll('.custom-toast').forEach(t => t.remove());
            const toast = document.createElement('div');
            toast.className = `custom-toast fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl z-50 transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-500' :
                type === 'warning' ? 'bg-gradient-to-r from-yellow-500 to-amber-500' :
                type === 'error' ? 'bg-gradient-to-r from-red-500 to-rose-500' : 
                'bg-gradient-to-r from-blue-500 to-indigo-500'
            } text-white`;
            const icons = { success: 'check-circle', warning: 'exclamation-triangle', error: 'times-circle', info: 'info-circle' };
            toast.innerHTML = `
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-${icons[type]} text-lg"></i>
                    </div>
                    <div>
                        <div class="font-semibold">${message}</div>
                        <div class="text-sm opacity-90 mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-x-full'), 10);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Field validation (inline)
        function validateField(field) {
            const value = field.value.trim();
            let isValid = true;
            let errorMessage = '';
            
            const existingError = field.parentElement.querySelector('.error-message');
            if (existingError) existingError.remove();
            field.classList.remove('field-error');
            
            if (field.hasAttribute('required') && !value) {
                isValid = false;
                errorMessage = 'This field is required.';
            }
            
            if (field.name.includes('passport_number') && value && !/^\d{9}$/.test(value)) {
                isValid = false;
                errorMessage = 'Passport number must be exactly 9 digits.';
            }
            
            if (!isValid) {
                field.classList.add('field-error');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMessage}`;
                field.parentElement.appendChild(errorDiv);
            }
            return isValid;
        }
        
        // Overall form validation
        function validateForm() {
            let isValid = true;
            let errorFields = [];
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
            
            const fields = document.querySelectorAll('#visaForm input, #visaForm select, #visaForm textarea');
            fields.forEach(field => {
                if (!validateField(field) && field.hasAttribute('required')) {
                    errorFields.push(field);
                }
            });
            
            // Date comparisons
            const departure = document.querySelector('[name="departure_date"]');
            const returnDate = document.querySelector('[name="return_date"]');
            if (departure && returnDate && departure.value && returnDate.value) {
                const dep = new Date(departure.value);
                const ret = new Date(returnDate.value);
                if (dep >= ret) {
                    isValid = false;
                    returnDate.classList.add('field-error');
                    let err = document.createElement('div');
                    err.className = 'error-message';
                    err.innerHTML = '<i class="fas fa-exclamation-circle"></i> Return date must be after departure date.';
                    returnDate.parentElement.appendChild(err);
                    errorFields.push(returnDate);
                }
            }
            
            const start = document.querySelector('[name="start_date"]');
            const max = document.querySelector('[name="max_date"]');
            if (start && max && start.value && max.value) {
                const s = new Date(start.value);
                const m = new Date(max.value);
                if (s > m) {
                    isValid = false;
                    max.classList.add('field-error');
                    let err = document.createElement('div');
                    err.className = 'error-message';
                    err.innerHTML = '<i class="fas fa-exclamation-circle"></i> Maximum date must be after minimum date.';
                    max.parentElement.appendChild(err);
                    errorFields.push(max);
                }
            }
            
            document.querySelectorAll('.applicant-card').forEach(card => {
                const issue = card.querySelector('[name$="passport_issue_date"]');
                const expiry = card.querySelector('[name$="passport_expiry"]');
                if (issue && expiry && issue.value && expiry.value) {
                    const i = new Date(issue.value);
                    const e = new Date(expiry.value);
                    if (i >= e) {
                        isValid = false;
                        expiry.classList.add('field-error');
                        let err = document.createElement('div');
                        err.className = 'error-message';
                        err.innerHTML = '<i class="fas fa-exclamation-circle"></i> Expiry date must be after issue date.';
                        expiry.parentElement.appendChild(err);
                        errorFields.push(expiry);
                    }
                }
            });
            
            return { isValid, errorFields };
        }
        
        const form = document.getElementById('visaForm');
        form.addEventListener('submit', function(e) {
            const { isValid, errorFields } = validateForm();
            if (!isValid) {
                e.preventDefault();
                showToast('Please correct the highlighted errors.', 'error');
                if (errorFields.length > 0) {
                    errorFields[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    errorFields[0].focus();
                }
            }
        });
        
        form.querySelectorAll('input, select, textarea').forEach(field => {
            field.addEventListener('blur', function() { validateField(this); });
        });
        
        const resetBtn = form.querySelector('button[type="reset"]');
        if (resetBtn) {
            resetBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Clear all form data? This cannot be undone.')) {
                    document.querySelectorAll('.applicant-card').forEach((f, idx) => { if (idx > 0) f.remove(); });
                    document.querySelectorAll('#visaForm input, #visaForm select, #visaForm textarea').forEach(f => {
                        if (f.type === 'checkbox' || f.type === 'radio') f.checked = false;
                        else if (f.tagName === 'SELECT') f.selectedIndex = 0;
                        else f.value = '';
                    });
                    formCount = 1;
                    totalForms.value = 1;
                    document.querySelectorAll('.error-message').forEach(el => el.remove());
                    document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
                    if (addBtn) {
                        addBtn.disabled = false;
                        addBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i> Add Another Applicant';
                        addBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        addBtn.classList.add('bg-gradient-to-r', 'from-indigo-600', 'to-purple-600', 'hover:from-indigo-700', 'hover:to-purple-700', 'hover:shadow-xl', 'hover:-translate-y-1');
                    }
                    showToast('Form cleared', 'info');
                }
            });
        }
    });
</script>
{% endblock %}