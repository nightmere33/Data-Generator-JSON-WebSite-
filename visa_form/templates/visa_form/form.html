{% extends 'visa_form/base.html' %}

{% block title %}Create Visa Data - Mosaic Visa Generator{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
    :root {
        --navy:     #0f2240;
        --navy-mid: #1a3a6c;
        --blue:     #4f46e5;
        --blue-lt:  #eef2ff;
        --gold:     #c9a84c;
        --border:   #e2e6ed;
        --muted:    #6b7a94;
        --text:     #0f1f35;
        --bg:       #f6f7f9;
        --surface:  #ffffff;
        --red:      #d0342c;
        --green:    #1a7a4a;
        --radius:   10px;
    }

    body { font-family: 'DM Sans', sans-serif; }

    /* ── Form section card ── */
    .form-section {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,.05);
        overflow: hidden;
    }

    /* ── Section header ── */
    .section-header {
        display: flex;
        align-items: center;
        padding: 22px 28px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(to right, #eef2fa, var(--surface));
        margin: 0;
        border-radius: 0;
    }

    .section-icon {
        background: var(--navy);
        color: white;
        width: 46px;
        height: 46px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 16px;
        font-size: 18px;
        flex-shrink: 0;
    }

    .section-header h2 {
        font-family: 'Syne', sans-serif;
        font-size: 17px;
        font-weight: 700;
        color: var(--navy);
        margin: 0;
    }

    .section-header p {
        font-size: 12px;
        color: var(--muted);
        margin: 3px 0 0;
    }

    /* ── Form controls ── */
    .form-input, .form-select, .form-textarea {
        font-family: 'DM Sans', sans-serif;
        font-size: 14px;
        color: var(--text);
        background: var(--bg);
        border: 1.5px solid var(--border);
        border-radius: var(--radius);
        padding: 11px 14px;
        width: 100%;
        outline: none;
        box-shadow: none;
        transition: border-color .2s, background .2s, box-shadow .2s;
        appearance: none;
        -webkit-appearance: none;
    }

    .form-select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='7' viewBox='0 0 12 7'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b7a94' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        padding-right: 36px;
    }

    .form-textarea { resize: vertical; min-height: 88px; }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        border-color: var(--navy);
        background: #fff;
        box-shadow: 0 0 0 3px rgba(15,34,64,.08);
    }

    .form-input:hover, .form-select:hover, .form-textarea:hover {
        border-color: #9ca3af;
    }

    .form-input::placeholder, .form-textarea::placeholder {
        color: #b0bac8;
    }

    /* ── Labels ── */
    .form-label {
        font-size: 11px;
        font-weight: 700;
        letter-spacing: .06em;
        text-transform: uppercase;
        color: var(--muted);
        margin-bottom: 7px;
        display: block;
    }

    .required-star { color: var(--red); margin-left: 2px; }

    .form-help {
        font-size: 11px;
        color: var(--muted);
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* ── Field group — flat, no nested card ── */
    .field-group {
        display: flex;
        flex-direction: column;
    }

    .field-group:focus-within .form-label {
        color: var(--navy);
    }

    /* ── Error state ── */
    .field-group.has-error .form-input,
    .field-group.has-error .form-select,
    .field-group.has-error .form-textarea {
        border-color: var(--red);
        background: #fff5f5;
    }

    /* ── Gold divider ── */
    .section-divider {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 24px 0 20px;
    }
    .section-divider::before, .section-divider::after {
        content: ''; flex: 1; height: 1px; background: var(--border);
    }
    .section-divider span {
        font-size: 10px;
        font-weight: 700;
        letter-spacing: .1em;
        text-transform: uppercase;
        color: var(--gold);
        white-space: nowrap;
    }

    /* ── Applicant card ── */
    .applicant-card {
        background: var(--surface);
        border: 1.5px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        transition: box-shadow .3s, transform .3s, opacity .3s;
        position: relative;
    }

    .applicant-card:hover {
        box-shadow: 0 6px 24px rgba(0,0,0,.09);
    }

    .applicant-card-header {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        background: linear-gradient(to right, #eef2fa, var(--surface));
        border-bottom: 1px solid var(--border);
    }

    .applicant-num {
        width: 36px; height: 36px;
        border-radius: 8px;
        background: var(--navy);
        color: #fff;
        display: flex; align-items: center; justify-content: center;
        font-family: 'Syne', sans-serif;
        font-size: 15px; font-weight: 700;
        flex-shrink: 0;
        margin-right: 12px;
    }

    .applicant-card h3 {
        font-family: 'Syne', sans-serif;
        font-size: 15px;
        font-weight: 700;
        color: var(--navy);
        margin: 0;
    }

    .applicant-card .applicant-sub {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
    }

    /* ── Remove button ── */
    .remove-applicant {
        position: absolute;
        top: 12px;
        right: 16px;
        background: #fff0f0;
        border: 1.5px solid #fecdcd;
        color: var(--red);
        border-radius: 8px;
        padding: 7px 12px;
        cursor: pointer;
        transition: all .2s;
        display: flex;
        align-items: center;
        gap: 6px;
        font-family: 'DM Sans', sans-serif;
        font-size: 12px;
        font-weight: 700;
        z-index: 10;
    }

    .remove-applicant:hover {
        background: var(--red);
        color: #fff;
        border-color: var(--red);
    }

    /* ── Progress bar ── */
    .progress-step {
        display: flex;
        align-items: center;
        position: relative;
        flex: 1;
    }

    .progress-step:not(:last-child)::after {
        content: '';
        position: absolute;
        left: 38px; right: 0;
        height: 2px;
        background: var(--border);
        top: 50%; transform: translateY(-50%);
        z-index: 1;
    }

    .step-indicator {
        width: 36px; height: 36px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-weight: 700; font-size: 14px;
        z-index: 2; position: relative;
        background: var(--bg);
        border: 2px solid var(--border);
        color: var(--muted);
        transition: all .3s;
        flex-shrink: 0;
    }

    .step-indicator.active {
        background: var(--navy);
        border-color: var(--navy);
        color: white;
        box-shadow: 0 4px 12px rgba(15,34,64,.25);
    }

    .step-indicator.completed {
        background: var(--green);
        border-color: var(--green);
        color: white;
    }

    .step-label {
        margin-left: 10px;
        font-size: 13px;
        font-weight: 600;
        color: var(--muted);
        white-space: nowrap;
    }

    .step-label.active { color: var(--navy); }
    .step-label.completed { color: var(--green); }

    @media(max-width: 560px) {
        .step-label { display: none; }
    }

    /* ── Form grid ── */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 20px;
    }

    @media(min-width: 768px) {
        .form-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* ── Add applicant button ── */
    #add-applicant {
        background: var(--navy);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-family: 'DM Sans', sans-serif;
        font-size: 13px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background .2s;
        flex-shrink: 0;
    }

    #add-applicant:hover { background: var(--navy-mid); }
    #add-applicant:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* ── Submit section ── */
    .submit-section {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px 28px;
        box-shadow: 0 2px 8px rgba(0,0,0,.05);
    }

    .btn-reset {
        background: var(--bg);
        border: 1.5px solid var(--border);
        color: var(--muted);
        border-radius: var(--radius);
        padding: 13px 24px;
        font-family: 'DM Sans', sans-serif;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all .2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-reset:hover { background: #eef0f4; color: var(--text); }

    .btn-submit {
        flex: 1;
        background: var(--navy);
        color: #fff;
        border: none;
        border-radius: var(--radius);
        padding: 13px 32px;
        font-family: 'DM Sans', sans-serif;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all .2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-submit:hover {
        background: var(--navy-mid);
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(15,34,64,.25);
    }

    .btn-submit:active { transform: none; }

    /* ── Toast ── */
    .custom-toast {
        position: fixed;
        top: 80px; right: 20px;
        padding: 14px 18px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 600;
        z-index: 9999;
        min-width: 260px;
        box-shadow: 0 8px 30px rgba(0,0,0,.12);
        transform: translateX(120%);
        transition: transform .3s cubic-bezier(.34,1.56,.64,1);
        font-family: 'DM Sans', sans-serif;
    }

    .custom-toast.show { transform: translateX(0); }

    .custom-toast.success { background: #f0fdf6; border: 1.5px solid #a7f3c8; color: #166534; }
    .custom-toast.warning { background: #fffbeb; border: 1.5px solid #fde68a; color: #92400e; }
    .custom-toast.error   { background: #fff5f5; border: 1.5px solid #fecdcd; color: #9b1c1c; }
    .custom-toast.info    { background: #eff6ff; border: 1.5px solid #bfdbfe; color: #1e40af; }

    /* ── Mobile ── */
    @media(max-width: 768px) {
        .section-header { padding: 16px; }
        .form-section > div:last-child { padding: 18px 16px; }
        .applicant-card { padding: 0; }
        .submit-section { padding: 18px 16px; }

        .form-input, .form-select, .form-textarea {
            font-size: 16px; /* prevent iOS zoom */
            padding: 13px 14px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">

    <!-- Page Heading -->
    <div class="mb-8">
        <h1 style="font-family:'Syne',sans-serif;font-size:clamp(22px,4vw,30px);font-weight:800;color:var(--navy);letter-spacing:-.02em">
            Visa Application Form
        </h1>
        <p style="color:var(--muted);font-size:14px;margin-top:4px">
            Fill in all required details to generate your JSON data file
        </p>
    </div>

    <!-- Progress Bar -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 24px;margin-bottom:32px;box-shadow:0 1px 4px rgba(0,0,0,.04)">
        <div class="flex items-center justify-between">
            <div class="progress-step">
                <div class="step-indicator active"><i class="fas fa-edit"></i></div>
                <span class="step-label active">Fill Form</span>
            </div>
            <div class="progress-step">
                <div class="step-indicator"><i class="fas fa-eye"></i></div>
                <span class="step-label">Preview JSON</span>
            </div>
            <div class="progress-step">
                <div class="step-indicator"><i class="fas fa-download"></i></div>
                <span class="step-label">Download</span>
            </div>
        </div>
    </div>

    <!-- Form -->
    <form method="post" class="space-y-6" id="visaForm">
        {% csrf_token %}

        <!-- Common Information -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon"><i class="fas fa-globe-americas"></i></div>
                <div>
                    <h2>Common Application Information</h2>
                    <p>Shared details for all applicants</p>
                </div>
            </div>

            <div class="p-6 md:p-8">
                <div class="form-grid">
                    <!-- Left -->
                    <div class="space-y-5">
                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-clock mr-1 text-blue-400"></i> Time Slot
                            </label>
                            {{ visa_form.slot }}
                            <p class="form-help"><i class="fas fa-info-circle"></i> Leave empty for random selection</p>
                        </div>

                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-file-alt mr-1 text-blue-400"></i> Visa Type <span class="required-star">*</span>
                            </label>
                            {{ visa_form.visa }}
                        </div>

                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-flag mr-1 text-blue-400"></i> Nationality <span class="required-star">*</span>
                            </label>
                            {{ visa_form.nationality }}
                        </div>
                    </div>

                    <!-- Right -->
                    <div class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="field-group">
                                <label class="form-label">
                                    <i class="fas fa-plane-departure mr-1 text-blue-400"></i> Departure <span class="required-star">*</span>
                                </label>
                                {{ visa_form.departure_date }}
                            </div>
                            <div class="field-group">
                                <label class="form-label">
                                    <i class="fas fa-plane-arrival mr-1 text-blue-400"></i> Return <span class="required-star">*</span>
                                </label>
                                {{ visa_form.return_date }}
                            </div>
                        </div>

                        <div class="field-group">
                            <label class="form-label">
                                <i class="fas fa-home mr-1 text-blue-400"></i> Contact Address <span class="required-star">*</span>
                            </label>
                            {{ visa_form.contact_address }}
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="field-group">
                                <label class="form-label">City <span class="required-star">*</span></label>
                                {{ visa_form.contact_city }}
                            </div>
                            <div class="field-group">
                                <label class="form-label">Postal Code <span class="required-star">*</span></label>
                                {{ visa_form.contact_postcode }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applicants Section -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon"><i class="fas fa-users"></i></div>
                <div class="flex-1">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h2>Applicants Information</h2>
                            <p>Add details for each applicant (maximum 5)</p>
                        </div>
                        <button type="button" id="add-applicant">
                            <i class="fas fa-user-plus"></i> Add Applicant
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-6 md:p-8">
                <div id="applicant-formset" class="space-y-6">
                    {{ applicant_formset.management_form }}

                    {% for form in applicant_formset %}
                    <div class="applicant-card" data-index="{{ forloop.counter0 }}">

                        <button type="button" class="remove-applicant" {% if forloop.first %}style="display:none"{% endif %} title="Remove">
                            <i class="fas fa-trash-alt"></i> Remove
                        </button>

                        <div class="applicant-card-header">
                            <div class="applicant-num">{{ forloop.counter }}</div>
                            <div>
                                <h3>Applicant {{ forloop.counter }}</h3>
                                <div class="applicant-sub">Personal and passport details</div>
                            </div>
                        </div>

                        <div class="p-6">
                            <div class="form-grid">
                                <!-- Left -->
                                <div class="space-y-5">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="field-group">
                                            <label class="form-label">First Name <span class="required-star">*</span></label>
                                            {{ form.name }}
                                        </div>
                                        <div class="field-group">
                                            <label class="form-label">Last Name <span class="required-star">*</span></label>
                                            {{ form.surname }}
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="field-group">
                                            <label class="form-label">Gender</label>
                                            {{ form.gender }}
                                        </div>
                                        <div class="field-group">
                                            <label class="form-label">Marital Status</label>
                                            {{ form.marital_status }}
                                        </div>
                                    </div>

                                    <div class="field-group">
                                        <label class="form-label">Date of Birth</label>
                                        {{ form.birthday }}
                                    </div>

                                    <div class="field-group">
                                        <label class="form-label">Place of Birth</label>
                                        {{ form.birth_place }}
                                    </div>

                                    <div class="field-group">
                                        <label class="form-label">Occupation</label>
                                        {{ form.occupation }}
                                    </div>
                                </div>

                                <!-- Right -->
                                <div class="space-y-5">
                                    <div class="field-group">
                                        <label class="form-label">Father's Full Name</label>
                                        {{ form.father_name }}
                                    </div>

                                    <div class="field-group">
                                        <label class="form-label">Mother's Full Name</label>
                                        {{ form.mother_name }}
                                    </div>

                                    <div class="section-divider"><span>Travel Document</span></div>

                                    <div class="field-group">
                                        <label class="form-label">Document Type</label>
                                        {{ form.travel_document }}
                                    </div>

                                    <div class="field-group">
                                        <label class="form-label">Passport Issued By</label>
                                        {{ form.passport_issued_by }}
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="field-group">
                                            <label class="form-label">Issue Date</label>
                                            {{ form.passport_issue_date }}
                                        </div>
                                        <div class="field-group">
                                            <label class="form-label">Expiry Date</label>
                                            {{ form.passport_expiry }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Submit -->
        <div class="submit-section">
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <button type="reset" class="btn-reset">
                    <i class="fas fa-redo"></i> Clear Form
                </button>
                <button type="submit" class="btn-submit">
                    <i class="fas fa-eye"></i>
                    Preview &amp; Generate JSON
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            <div class="flex flex-wrap gap-6 pt-5 border-t border-gray-100">
                <div class="flex items-center gap-2 text-sm" style="color:var(--muted)">
                    <i class="fas fa-shield-alt" style="color:var(--navy)"></i>
                    Data processed locally, never stored
                </div>
                <div class="flex items-center gap-2 text-sm" style="color:var(--muted)">
                    <i class="fas fa-calendar-alt" style="color:var(--navy)"></i>
                    Dates in YYYY-MM-DD format
                </div>
                <div class="flex items-center gap-2 text-sm" style="color:var(--muted)">
                    <i class="fas fa-asterisk" style="color:var(--red);font-size:9px"></i>
                    Fields marked * are required
                </div>
            </div>
        </div>

    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const formset    = document.getElementById('applicant-formset');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const addBtn     = document.getElementById('add-applicant');
        let formCount    = parseInt(totalForms.value);

        /* ── Toast ── */
        function showToast(message, type = 'info') {
            document.querySelectorAll('.custom-toast').forEach(t => t.remove());
            const icons = { success:'check-circle', warning:'exclamation-triangle', error:'times-circle', info:'info-circle' };
            const toast = document.createElement('div');
            toast.className = `custom-toast ${type}`;
            toast.innerHTML = `<i class="fas fa-${icons[type]}" style="font-size:18px;flex-shrink:0"></i><span>${message}</span>`;
            document.body.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 350);
            }, 4000);
        }

        /* ── Remove button ── */
        function initRemoveButtons() {
            document.querySelectorAll('.remove-applicant').forEach((btn, index) => {
                if (index === 0) btn.style.display = 'none';
                btn.addEventListener('click', function() {
                    const card = this.closest('.applicant-card');
                    if (formCount > 1) {
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(60px)';
                        setTimeout(() => {
                            card.remove();
                            formCount--;
                            totalForms.value = formCount;
                            updateFormIndices();
                            showToast('Applicant removed', 'info');
                        }, 280);
                    }
                });
            });
        }

        initRemoveButtons();

        /* ── Add applicant ── */
        if (addBtn) {
            addBtn.addEventListener('click', function() {
                if (formCount >= 5) {
                    showToast('Maximum of 5 applicants allowed', 'warning');
                    return;
                }

                const template = document.querySelector('.applicant-card');
                const newForm  = template.cloneNode(true);

                newForm.dataset.index = formCount;

                // Update field names/IDs and clear values
                newForm.querySelectorAll('input, select, textarea').forEach(input => {
                    if (input.name) input.name = input.name.replace(/-\d+-/, `-${formCount}-`);
                    if (input.id)   input.id   = input.id.replace(/-\d+-/, `-${formCount}-`);
                    if (input.type !== 'hidden') input.value = '';
                });

                // Update number and title
                const num = newForm.querySelector('.applicant-num');
                if (num) num.textContent = formCount + 1;
                const title = newForm.querySelector('h3');
                if (title) title.textContent = `Applicant ${formCount + 1}`;

                // Show remove button
                const removeBtn = newForm.querySelector('.remove-applicant');
                if (removeBtn) {
                    removeBtn.style.display = 'flex';
                    removeBtn.addEventListener('click', function() {
                        const card = this.closest('.applicant-card');
                        if (formCount > 1) {
                            card.style.opacity = '0';
                            card.style.transform = 'translateX(60px)';
                            setTimeout(() => {
                                card.remove();
                                formCount--;
                                totalForms.value = formCount;
                                updateFormIndices();
                                showToast('Applicant removed', 'info');
                            }, 280);
                        }
                    });
                }

                // Animate in
                newForm.style.opacity = '0';
                newForm.style.transform = 'translateY(16px)';
                newForm.style.transition = 'opacity .3s, transform .3s';
                formset.appendChild(newForm);
                requestAnimationFrame(() => {
                    newForm.style.opacity = '1';
                    newForm.style.transform = 'translateY(0)';
                });

                formCount++;
                totalForms.value = formCount;

                setTimeout(() => newForm.scrollIntoView({ behavior: 'smooth', block: 'center' }), 120);
                showToast(`Applicant ${formCount} added!`, 'success');

                if (formCount >= 5) {
                    addBtn.disabled = true;
                    addBtn.innerHTML = '<i class="fas fa-ban"></i> Maximum Reached';
                }
            });
        }

        /* ── Reindex ── */
        function updateFormIndices() {
            document.querySelectorAll('.applicant-card').forEach((card, index) => {
                card.dataset.index = index;
                const num = card.querySelector('.applicant-num');
                if (num) num.textContent = index + 1;
                const title = card.querySelector('h3');
                if (title) title.textContent = `Applicant ${index + 1}`;
                card.querySelectorAll('input, select, textarea').forEach(input => {
                    if (input.name) input.name = input.name.replace(/-\d+-/, `-${index}-`);
                    if (input.id)   input.id   = input.id.replace(/-\d+-/, `-${index}-`);
                });
                const rm = card.querySelector('.remove-applicant');
                if (rm) rm.style.display = index === 0 ? 'none' : 'flex';
            });

            if (formCount < 5 && addBtn) {
                addBtn.disabled = false;
                addBtn.innerHTML = '<i class="fas fa-user-plus"></i> Add Applicant';
            }
        }

        /* ── Reset ── */
        const resetBtn = document.querySelector('button[type="reset"]');
        if (resetBtn) {
            resetBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (!confirm('Clear all form data? This cannot be undone.')) return;
                document.querySelectorAll('.applicant-card').forEach((c, i) => { if (i > 0) c.remove(); });
                formCount = 1;
                totalForms.value = 1;
                updateFormIndices();
                document.getElementById('visaForm').reset();
                showToast('Form cleared', 'info');
            });
        }

        /* ── Validation ── */
        document.getElementById('visaForm').addEventListener('submit', function(e) {
            let valid = true, first = null;
            this.querySelectorAll('[required]').forEach(field => {
                const wrap = field.closest('.field-group');
                if (!field.value.trim()) {
                    valid = false;
                    if (wrap) wrap.classList.add('has-error');
                    if (!first) first = field;
                } else {
                    if (wrap) wrap.classList.remove('has-error');
                }
            });
            if (!valid) {
                e.preventDefault();
                showToast('Please fill in all required fields', 'error');
                if (first) { first.scrollIntoView({ behavior: 'smooth', block: 'center' }); first.focus(); }
            }
        });

        // Remove error state on input
        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('input', function() {
                const wrap = this.closest('.field-group');
                if (wrap && this.value.trim()) wrap.classList.remove('has-error');
            });
        });
    });
</script>
{% endblock %}